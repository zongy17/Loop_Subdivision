<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A-4：使用半边结构实现网格简化算法QSlim</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
<ul>
<li>
<ul>
<li></li>
</ul>
</li>
<li></li>
<li>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>
</li>
<li></li>
<li>
<ul>
<li></li>
<li></li>
</ul>
</li>
</ul>

    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <p></p><div class="toc"><h3>A-4. 使用半边结构实现网格加密算法-Loop scheme</h3><ul><li><a href="#_7">算法介绍</a></li><li><a href="#_43">算法实现</a></li><ul><li><a href="#_44">加入新的边点</a></li><li><a href="#_135">设置新加入边点的坐标</a></li><li><a href="#_161">调整原有旧顶点的坐标</a></li><li><a href="#_195">加入新的网格拓扑（点边面关系）</a></li></ul><li><a href="#_212">交互控制加密程度</a></li><li><a href="#_239">效果</a></li><ul><li><a href="#_240">斯坦福牛</a></li><li><a href="#Dinosaur_258">Dinosaur</a></li></ul></ul></div><br>
作业要求：<p></p>
<ol>
<li>具体方法参见下面的链接 <a href="http://multires.caltech.edu/pubs/sig99notes.pdf">http://multires.caltech.edu/pubs/sig99notes.pdf</a>, 第 46 页，3.1 节（但实际上好像在4.2节？）</li>
<li>可以选择网格加密选项</li>
</ol>
<p>注：不得不说，对于要自己造轮子的半边网格结构，A-4加密细分的作业远比B-7的QSlim简化要简单，因为加密只需要在原有网格上添加元素，不涉及删除，因而不需要顾忌删除过程中的<code>is_collapse_OK</code>（如面flip）而致崩溃的问题。所以建议以后将B-7的简化算法实现也加入到A类作业中。</p>
<h1><a id="_7"></a>算法介绍</h1>
<p>现有的细分方案可以根据下面的三个简单的原则进行分类：</p>
<ul>
<li>细化规则的类型(顶点插入或切角)</li>
<li>生成的网格类型(三角形或四边形)</li>
<li>方案是近似的还是插值的</li>
</ul>
<p>不同代表的方案如下表所示。<br>
<img src="https://img-blog.csdnimg.cn/d1065a9394624908a298d58662fb4220.png" alt="在这里插入图片描述"></p>
<p>最简单的细分方案之一是Loop方案，由Charles Loop发明。Loop方案属于顶点插入类型，是为三角形网格而设计的，如下图所示。新的顶点显示为黑点。原（粗）网格的每条边被分割成两条，新的顶点重新连接形成4个新的三角形，替换原（粗）网格中的每个三角形。<br>
<img src="https://img-blog.csdnimg.cn/20f3c6abae414f2eaf43eb25ff7a45e9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
像大多数（但不是所有）其他细分方案一样，这种方案是基于样条基函数，称为三向四次盒样条。不同于更传统的样条（如双三次样条），三向盒样条被定义在规则三角形网格上。此样条的生成多项式为<br>
<span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><mo stretchy="false">(</mo><msub><mi>z</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>z</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mn>16</mn></mfrac><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><msub><mi>z</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><msub><mi>z</mi><mn>2</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><msub><mi>z</mi><mn>1</mn></msub><msub><mi>z</mi><mn>2</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">S(z_1,z_2)=\frac{1}{16}(1+z_1)^2(1+z_2)^2(1+z_1z_2)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.05764em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.04398em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.04398em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.00744em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">6</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.11411em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.04398em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.11411em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.04398em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.11411em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.04398em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.04398em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>这个样条基函数是<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>C</mi><mn>2</mn></msup><mo>−</mo></mrow><annotation encoding="application/x-tex">C^2-</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.897438em; vertical-align: -0.08333em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em;">C</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord">−</span></span></span></span></span>连续的。它的细分规则和细分系数如下图所示。<br>
<img src="https://img-blog.csdnimg.cn/1f3fead34a3a42f2a2e1b93bad79450c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_19,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
在一维情况中，一旦选择了样条基函数，生成曲线所需的细分规则的所有系数就完全确定了。对于表面来说，情况完全不同，且更加复杂。曲线的控制多边形的结构总是非常简单：顶点排列成一条链，链上的任意两个相同长度的部分总是具有相同的结构。</p>
<p>对于二维网格，网格的局部结构可能是不同的：连接到一个顶点的边的数量可能是不同的。所以，从样条基函数导出的规则<strong>只能应用于局部规则网格的部分</strong>；也就是说，只对那些价为6的顶点（在三角网格的情况下）。在其他情况下，我们必须为具有不同价的顶点设计新的规则。这样的顶点称为<strong>非标准顶点</strong>。</p>
<p>目前，我们只考虑了没有边界的网格。注意，用于计算插入在边缘上的控制点的四次方框样条规则（左上图）可以应用于任何地方。唯一需要修改的规则是如何计算从上一级继承的控制点的新位置。</p>
<p><strong>Loop建议使用如下图所示的系数</strong>。结果表明，这种系数的选择保证了方案的极限表面（无限细分的表面）是“光滑的”。注意，这些新规则只影响非规则顶点附近表面的局部行为。<br>
<img src="https://img-blog.csdnimg.cn/fa8aa9ad106646c1954b0f1383b3cb9c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
整个<strong>Loop细分算法可以描述如下</strong>：</p>
<ol>
<li>对每一个三角形面片，在三条边上各加入一个顶点（称为“<strong>边点</strong>”）<br>
边点位置由周围的原（粗）网格的顶点位置加权确定，权系数遵循以下规则：
<ol>
<li>如果边不在网格边界上：按上图（a）的interior规则计算边点的位置，即该边上两个端点权值各为3/8，该边所对的两个对面顶点的权值各为1/8</li>
<li>如果边在网格边界：按上图（a）的crease and boundary规则计算边点的位置，即该边上两个端点权值各为1/2</li>
</ol>
</li>
<li>对于原（粗）网格的旧有顶点（非<strong>边点</strong>），要调整它们的位置<br>
旧顶点位置由原（粗）网格的顶点位置加权确定（注意：新加入的<strong>边点</strong>不对旧有顶点位置产生影响），权系数遵循以下规则：
<ol>
<li>如果该旧顶点位于边界上（有2个也位于边界的旧顶点邻居）：按上图（b）的crease and boundary规则调整边顶点的位置，即自己原位置权重3/4，另两个边界旧顶点邻居权重1/8</li>
<li>如果该旧顶点位于网格内部：按上图（b）的interior规则调整，即自己原位置权重<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mo>−</mo><mi>k</mi><mi>β</mi></mrow><annotation encoding="application/x-tex">1-k\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="mord mathdefault" style="margin-right: 0.05278em;">β</span></span></span></span></span>，其它旧有顶点邻居权重<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault" style="margin-right: 0.05278em;">β</span></span></span></span></span>，其中<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span></span></span></span></span>为旧顶点邻居的数目，<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault" style="margin-right: 0.05278em;">β</span></span></span></span></span>按照上图的一种方式取。</li>
</ol>
</li>
</ol>
<h1><a id="_43"></a>算法实现</h1>
<h2><a id="_44"></a>加入新的边点</h2>
<p>遍历三角形网格的每一个面片<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault">A</span></span></span></span></span>，给面的三条边对应加上一个顶点，线性时间复杂度。注意，此时形成4个新的三角形面片<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>A</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>A</mi><mn>3</mn></msub><mo separator="true">,</mo><msub><mi>A</mi><mn>4</mn></msub></mrow><annotation encoding="application/x-tex">A_1, A_2, A_3, A_4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.87777em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，而新网格中不再包含原有的<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault">A</span></span></span></span></span>。</p>
<pre><code class="prism language-cpp">zyMesh <span class="token function">LoopSubdivide_native</span><span class="token punctuation">(</span>zyMesh <span class="token operator">&amp;</span> mesh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回的加密网格先保留粗网格的顶点信息（仅有位置，无拓扑）</span>
    zyMesh newMesh<span class="token punctuation">;</span>
    size_t nVerts <span class="token operator">=</span> mesh<span class="token punctuation">.</span>vertexList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nVerts<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        newMesh<span class="token punctuation">.</span><span class="token function">add_vertex</span><span class="token punctuation">(</span>mesh<span class="token punctuation">.</span>vertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

    size_t nFaces <span class="token operator">=</span> mesh<span class="token punctuation">.</span>faceList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t newIndexOfVertices <span class="token operator">=</span> nVerts<span class="token punctuation">;</span>

    std<span class="token operator">::</span>unordered_map<span class="token operator">&lt;</span>Index_Pair2<span class="token punctuation">,</span> Index_Pair3<span class="token punctuation">,</span> Index_Pair2_hash<span class="token operator">&gt;</span> edgeVertice<span class="token punctuation">;</span>

    size_t <span class="token operator">*</span> newFaces <span class="token operator">=</span> <span class="token keyword">new</span> size_t<span class="token punctuation">[</span>nFaces<span class="token operator">*</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//面数将会是原来的四倍</span>
    size_t newFaces_ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建一个新的边点矩阵即edgeVertice以及新的三角面newFaces.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t f_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> f_id <span class="token operator">&lt;</span> mesh<span class="token punctuation">.</span>faceList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> f_id<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> vids<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        size_t start_halfedge_id <span class="token operator">=</span> mesh<span class="token punctuation">.</span>faceList<span class="token punctuation">[</span>f_id<span class="token punctuation">]</span><span class="token punctuation">.</span>start_halfegde_id<span class="token punctuation">;</span>
        size_t halfedge_id <span class="token operator">=</span> start_halfedge_id<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            vids<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> mesh<span class="token punctuation">.</span>halfedgeList<span class="token punctuation">[</span>halfedge_id<span class="token punctuation">]</span><span class="token punctuation">.</span>from_vertex_id<span class="token punctuation">;</span>
            halfedge_id <span class="token operator">=</span> mesh<span class="token punctuation">.</span>halfedgeList<span class="token punctuation">[</span>halfedge_id<span class="token punctuation">]</span><span class="token punctuation">.</span>next_halfedge_id<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>halfedge_id <span class="token operator">!=</span> start_halfedge_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        size_t vpIndex <span class="token operator">=</span> <span class="token function">addEdgeVertice</span><span class="token punctuation">(</span>edgeVertice<span class="token punctuation">,</span> vids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vids<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vids<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newIndexOfVertices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vpIndex <span class="token operator">&gt;=</span> newMesh<span class="token punctuation">.</span>vertexList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// vpIndex之前没有加进去过</span>
            newMesh<span class="token punctuation">.</span><span class="token function">add_vertex</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        size_t vqIndex <span class="token operator">=</span> <span class="token function">addEdgeVertice</span><span class="token punctuation">(</span>edgeVertice<span class="token punctuation">,</span> vids<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vids<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newIndexOfVertices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vqIndex <span class="token operator">&gt;=</span> newMesh<span class="token punctuation">.</span>vertexList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            newMesh<span class="token punctuation">.</span><span class="token function">add_vertex</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        size_t vrIndex <span class="token operator">=</span> <span class="token function">addEdgeVertice</span><span class="token punctuation">(</span>edgeVertice<span class="token punctuation">,</span> vids<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vids<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newIndexOfVertices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vrIndex <span class="token operator">&gt;=</span> newMesh<span class="token punctuation">.</span>vertexList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            newMesh<span class="token punctuation">.</span><span class="token function">add_vertex</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        newFaces<span class="token punctuation">[</span>newFaces_ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> vids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> newFaces<span class="token punctuation">[</span>newFaces_ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> vpIndex<span class="token punctuation">;</span> newFaces<span class="token punctuation">[</span>newFaces_ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> vrIndex<span class="token punctuation">;</span>
        newFaces<span class="token punctuation">[</span>newFaces_ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> vpIndex<span class="token punctuation">;</span> newFaces<span class="token punctuation">[</span>newFaces_ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> vids<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> newFaces<span class="token punctuation">[</span>newFaces_ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> vqIndex<span class="token punctuation">;</span>
        newFaces<span class="token punctuation">[</span>newFaces_ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> vrIndex<span class="token punctuation">;</span> newFaces<span class="token punctuation">[</span>newFaces_ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> vqIndex<span class="token punctuation">;</span> newFaces<span class="token punctuation">[</span>newFaces_ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> vids<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        newFaces<span class="token punctuation">[</span>newFaces_ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> vrIndex<span class="token punctuation">;</span> newFaces<span class="token punctuation">[</span>newFaces_ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> vpIndex<span class="token punctuation">;</span> newFaces<span class="token punctuation">[</span>newFaces_ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> vqIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>注意每个面与3条半边联系在一起，而如果每条半边都新添加一个边点，则每个边点都会被添加两次而造成重复！因此需要在加入时，判断之前是否加入过这个位置（这条边）上的顶点了！这个新加入边点的<strong>唯一性</strong>通过边两端的顶点来唯一标记，并通过一个从<code>Index_Pair2</code>到<code>Index_Pair3</code>的哈希表来维护以便后续可以快速查询：</p>
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Index_Pair2</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    size_t v1<span class="token punctuation">,</span> v2<span class="token punctuation">;</span>
    <span class="token function">Index_Pair2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">v1</span><span class="token punctuation">(</span>IndexNotValid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">v2</span><span class="token punctuation">(</span>IndexNotValid<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">Index_Pair2</span><span class="token punctuation">(</span>size_t v1<span class="token punctuation">,</span> size_t v2<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">v1</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">v2</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">==</span> <span class="token punctuation">(</span>Index_Pair2 <span class="token keyword">const</span> <span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> v1 <span class="token operator">==</span> b<span class="token punctuation">.</span>v1 <span class="token operator">&amp;&amp;</span> v2 <span class="token operator">==</span> b<span class="token punctuation">.</span>v2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Index_Pair3</span><span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    size_t vN<span class="token punctuation">,</span> voppo1<span class="token punctuation">,</span> voppo2<span class="token punctuation">;</span>
    <span class="token function">Index_Pair3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">vN</span><span class="token punctuation">(</span>IndexNotValid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">voppo1</span><span class="token punctuation">(</span>IndexNotValid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">voppo2</span><span class="token punctuation">(</span>IndexNotValid<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">Index_Pair3</span><span class="token punctuation">(</span>size_t vN<span class="token punctuation">,</span> size_t voppo1<span class="token punctuation">,</span> size_t voppo2<span class="token operator">=</span>IndexNotValid<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">vN</span><span class="token punctuation">(</span>vN<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">voppo1</span><span class="token punctuation">(</span>voppo1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">voppo2</span><span class="token punctuation">(</span>voppo2<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">Index_Pair2_hash</span>	<span class="token punctuation">{</span>    
    size_t <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Index_Pair2 <span class="token keyword">const</span> <span class="token operator">&amp;</span> x<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>        
        <span class="token keyword">return</span> <span class="token function">hash_val</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>v1<span class="token punctuation">,</span> x<span class="token punctuation">.</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>函数<code>addEdgeVertice()</code>接受一条边上的两个顶点<code>v1Index</code>，<code>v2Index</code>，查询这个点是否已经在<code>edgeVertice</code>的哈希表中，如果不存在，则加入这个新边点的序号为<code>newIndex</code>，并记录这条边所对着的第一个旧有顶点序号为<code>v3Index</code>；如果已经存在，则更新这条边所对着的第二个旧有顶点序号为<code>v3Index</code>。因此可以通过<code>addEdgeVertice()</code>的返回值判断这次是否有插入新的边点，从而是否需要调用<code>zyMesh::add_vertex()</code>添加新的顶点实例。</p>
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">addEdgeVertice</span><span class="token punctuation">(</span>std<span class="token operator">::</span>unordered_map<span class="token operator">&lt;</span>Index_Pair2<span class="token punctuation">,</span>Index_Pair3<span class="token punctuation">,</span> Index_Pair2_hash<span class="token operator">&gt;</span> <span class="token operator">&amp;</span> edgeVertice<span class="token punctuation">,</span> \
    size_t v1Index<span class="token punctuation">,</span> size_t v2Index<span class="token punctuation">,</span> size_t v3Index<span class="token punctuation">,</span> size_t <span class="token operator">&amp;</span> newIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>v1Index <span class="token operator">&gt;</span> v2Index<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// setting v1 &lt;= v2</span>
        <span class="token keyword">int</span> vtmp <span class="token operator">=</span> v1Index<span class="token punctuation">;</span>
        v1Index <span class="token operator">=</span> v2Index<span class="token punctuation">;</span>
        v2Index <span class="token operator">=</span> vtmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Index_Pair2 <span class="token function">verts_pair</span><span class="token punctuation">(</span>v1Index<span class="token punctuation">,</span> v2Index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>edgeVertice<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>verts_pair<span class="token punctuation">)</span> <span class="token operator">==</span> edgeVertice<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//new vertex</span>
        edgeVertice<span class="token punctuation">[</span>verts_pair<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Index_Pair3</span><span class="token punctuation">(</span>newIndex<span class="token operator">++</span><span class="token punctuation">,</span> v3Index<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//新加入顶点的编号 和边(v1Index,v2Index)对着的第一个顶点v3Index</span>
    <span class="token keyword">else</span> 
        edgeVertice<span class="token punctuation">[</span>verts_pair<span class="token punctuation">]</span><span class="token punctuation">.</span>voppo2 <span class="token operator">=</span> v3Index<span class="token punctuation">;</span>
    <span class="token keyword">return</span> edgeVertice<span class="token punctuation">[</span>verts_pair<span class="token punctuation">]</span><span class="token punctuation">.</span>vN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="_135"></a>设置新加入边点的坐标</h2>
<p>新加入边点的坐标，直接由旧有顶点的坐标加权平均。由于哈希表<code>edgeVertice</code>中存储的每一项就是一个新加入的边点，因此直接遍历<code>edgeVertice</code>去修改顶点<code>vN</code>坐标即可，线性时间复杂度。</p>
<pre><code class="prism language-cpp">zyMesh <span class="token function">LoopSubdivide_native</span><span class="token punctuation">(</span>zyMesh <span class="token operator">&amp;</span> mesh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">//  更新插入顶点（新顶点位置直接确定）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token operator">::</span>unordered_map<span class="token operator">&lt;</span>Index_Pair2<span class="token punctuation">,</span> Index_Pair3<span class="token punctuation">,</span> Index_Pair2_hash<span class="token operator">&gt;</span><span class="token operator">::</span>iterator it <span class="token operator">=</span> edgeVertice<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> edgeVertice<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 性能高效版</span>
        size_t v1 <span class="token operator">=</span> it<span class="token operator">-&gt;</span>first<span class="token punctuation">.</span>v1<span class="token punctuation">,</span> v2 <span class="token operator">=</span> it<span class="token operator">-&gt;</span>first<span class="token punctuation">.</span>v2<span class="token punctuation">;</span>
        size_t vN <span class="token operator">=</span> it<span class="token operator">-&gt;</span>second<span class="token punctuation">.</span>vN<span class="token punctuation">;</span>
        size_t vOppo1 <span class="token operator">=</span> it<span class="token operator">-&gt;</span>second<span class="token punctuation">.</span>voppo1<span class="token punctuation">,</span> vOppo2 <span class="token operator">=</span> it<span class="token operator">-&gt;</span>second<span class="token punctuation">.</span>voppo2<span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>vN <span class="token operator">!=</span> IndexNotValid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>v1 <span class="token operator">!=</span> IndexNotValid <span class="token operator">&amp;&amp;</span> v2 <span class="token operator">!=</span> IndexNotValid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>vOppo1 <span class="token operator">!=</span> IndexNotValid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vec3 v1_pos <span class="token operator">=</span> newMesh<span class="token punctuation">.</span>vertexData<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">.</span>Position<span class="token punctuation">,</span> v2_pos <span class="token operator">=</span> newMesh<span class="token punctuation">.</span>vertexData<span class="token punctuation">[</span>v2<span class="token punctuation">]</span><span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vOppo2 <span class="token operator">==</span> IndexNotValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newMesh<span class="token punctuation">.</span>vertexData<span class="token punctuation">[</span>vN<span class="token punctuation">]</span><span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>v1_pos<span class="token operator">+</span>v2_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            vec3 vNOppo1_pos <span class="token operator">=</span> newMesh<span class="token punctuation">.</span>vertexData<span class="token punctuation">[</span>vOppo1<span class="token punctuation">]</span><span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
            vec3 vNOppo2_pos <span class="token operator">=</span> newMesh<span class="token punctuation">.</span>vertexData<span class="token punctuation">[</span>vOppo2<span class="token punctuation">]</span><span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
            vec3 new_pos <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.375f</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>v1_pos<span class="token operator">+</span>v2_pos<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.125f</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>vNOppo1_pos<span class="token operator">+</span>vNOppo2_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newMesh<span class="token punctuation">.</span>vertexData<span class="token punctuation">[</span>vN<span class="token punctuation">]</span><span class="token punctuation">.</span>Position <span class="token operator">=</span> new_pos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="_161"></a>调整原有旧顶点的坐标</h2>
<p>遍历原（粗）网格的旧有顶点，逐个更新位置。关于它是否位于边界，可以用<code>edgeVertice</code>中对应项的<code>voppo2</code>变量判断。</p>
<pre><code class="prism language-cpp">zyMesh <span class="token function">LoopSubdivide_native</span><span class="token punctuation">(</span>zyMesh <span class="token operator">&amp;</span> mesh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">// 顶点位置的调整(调整的是原顶点，依据的也是原顶点的拓扑关系，新加顶点不用动也不产生影响)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t v <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> v <span class="token operator">&lt;</span> nVerts<span class="token punctuation">;</span> v<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vec3 new_pos <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span> adj_boundary_pos <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> adj_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> adj_boundary_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span> <span class="token keyword">const</span> <span class="token operator">&amp;</span> out_he_lists <span class="token operator">=</span> mesh<span class="token punctuation">.</span>vertexList<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">.</span>outgoing_halfedge_ids<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> i_ngb <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i_ngb <span class="token operator">&lt;</span> out_he_lists<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i_ngb<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size_t vv <span class="token operator">=</span> mesh<span class="token punctuation">.</span>halfedgeList<span class="token punctuation">[</span>out_he_lists<span class="token punctuation">[</span>i_ngb<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_vertex_id<span class="token punctuation">;</span>
            <span class="token keyword">int</span> loc <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span>vv<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">*</span>nVerts <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span>vv<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>edgeVertice<span class="token punctuation">[</span><span class="token function">Index_Pair2</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>vv<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>vv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>voppo2 <span class="token operator">==</span> IndexNotValid<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//这个边点对着的第二个顶点为空，说明是边界边的边点</span>
                adj_boundary_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
                adj_boundary_pos <span class="token operator">+=</span> mesh<span class="token punctuation">.</span>vertexData<span class="token punctuation">[</span>vv<span class="token punctuation">]</span><span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            new_pos <span class="token operator">+=</span> mesh<span class="token punctuation">.</span>vertexData<span class="token punctuation">[</span>vv<span class="token punctuation">]</span><span class="token punctuation">.</span>Position<span class="token punctuation">;</span>
            adj_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>adj_boundary_cnt <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            new_pos <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.75f</span><span class="token punctuation">)</span> <span class="token operator">*</span> mesh<span class="token punctuation">.</span>vertexData<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">.</span>Position <span class="token operator">+</span> <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.125f</span><span class="token punctuation">)</span><span class="token operator">*</span>adj_boundary_pos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">double</span> val <span class="token operator">=</span> <span class="token number">0.375</span> <span class="token operator">+</span> <span class="token number">0.25</span><span class="token operator">*</span><span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>PI<span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>adj_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">double</span> beta <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.625</span> <span class="token operator">-</span> val<span class="token operator">*</span>val<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>adj_cnt<span class="token punctuation">;</span>
            new_pos <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> beta<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>adj_cnt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span>mesh<span class="token punctuation">.</span>vertexData<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">.</span>Position <span class="token operator">+</span> <span class="token function">vec3</span><span class="token punctuation">(</span>beta<span class="token punctuation">)</span><span class="token operator">*</span>new_pos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        newMesh<span class="token punctuation">.</span>vertexData<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">.</span>Position <span class="token operator">=</span> new_pos<span class="token punctuation">;</span><span class="token comment">//设置到新的细网格位置</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="_195"></a>加入新的网格拓扑（点边面关系）</h2>
<p>这一步很简单，只是根据已经得到的新（细）网格上的所有顶点坐标，和组成面的顶点序号信息，通过调用<code>zyMesh::add_face()</code>函数构建一张新的网格。</p>
<pre><code class="prism language-cpp">zyMesh <span class="token function">LoopSubdivide_native</span><span class="token punctuation">(</span>zyMesh <span class="token operator">&amp;</span> mesh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">// 在新的加密网格上构建面的拓扑</span>
    <span class="token keyword">int</span> new_nFaces <span class="token operator">=</span> newFaces_ptr <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> f <span class="token operator">&lt;</span> new_nFaces<span class="token punctuation">;</span> f<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> loc <span class="token operator">=</span> f<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>size_t<span class="token operator">&gt;</span> face_vh <span class="token operator">=</span> <span class="token punctuation">{</span>newFaces<span class="token punctuation">[</span>loc<span class="token punctuation">]</span><span class="token punctuation">,</span> newFaces<span class="token punctuation">[</span>loc<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newFaces<span class="token punctuation">[</span>loc<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        newMesh<span class="token punctuation">.</span><span class="token function">add_face</span><span class="token punctuation">(</span>face_vh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newFaces<span class="token punctuation">;</span>
    <span class="token keyword">return</span> newMesh<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h1><a id="_212"></a>交互控制加密程度</h1>
<p>类似B-7作业QSlim中交互控制简化程度。程序中设置了最大细分等级<code>max_level</code>（用户运行程序时输入的参数，具体运行方式见README.md文件），在渲染循环中，每帧都调用<code>processInput()</code>函数，来根据用户对键盘左右方向键的长按操作来实现细分等级的切换。程序动态根据用户希望的细分等级来<strong>实时</strong>生成加密网格，并加入到网格列表<code>meshList</code>中。</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">renderMain</span><span class="token punctuation">(</span>GLFWwindow <span class="token operator">*</span> window<span class="token punctuation">,</span> std<span class="token operator">::</span>string filename_nopfx<span class="token punctuation">,</span> Shader <span class="token operator">&amp;</span> ourShader<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>zyMesh<span class="token operator">&gt;</span> <span class="token operator">&amp;</span> meshList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">glfwWindowShouldClose</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// input</span>
        <span class="token function">processInput</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>meshList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;</span> max_level <span class="token operator">&amp;&amp;</span> meshList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;=</span> subdvs_level_f<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 如果当前meshList内已经有足够的（max_level）网格，则不再细分</span>
            <span class="token function">doSubdivision</span><span class="token punctuation">(</span>meshList<span class="token punctuation">[</span>subdivision_level<span class="token punctuation">]</span><span class="token punctuation">,</span> filename_nopfx<span class="token punctuation">,</span> meshList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span><span class="token comment">// while</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">processInput</span><span class="token punctuation">(</span>GLFWwindow <span class="token operator">*</span>window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">glfwGetKey</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> GLFW_KEY_LEFT<span class="token punctuation">)</span> <span class="token operator">==</span> GLFW_PRESS<span class="token punctuation">)</span><span class="token punctuation">{</span>
        subdvs_level_f <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> subdvs_level_f<span class="token operator">-</span><span class="token number">0.001f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subdivision_level <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>subdvs_level_f<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">glfwGetKey</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> GLFW_KEY_RIGHT<span class="token punctuation">)</span> <span class="token operator">==</span> GLFW_PRESS<span class="token punctuation">)</span><span class="token punctuation">{</span>
        subdvs_level_f <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>max_level<span class="token punctuation">,</span> subdvs_level_f<span class="token operator">+</span><span class="token number">0.001f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subdivision_level <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>subdvs_level_f<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h1><a id="_239"></a>效果</h1>
<h2><a id="_240"></a>斯坦福牛</h2>
<p>加密等级为0，1，2，3时的网格，其中等级0的为原网格。</p>
<table>
    <tbody><tr>
        <td><center><img src="https://img-blog.csdnimg.cn/fc1a22ad89c946278734261f2365407c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16">0</center></td>
        <td><center><img src="https://img-blog.csdnimg.cn/f86250f52de54d37837896acd76df260.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16">1</center></td>
    </tr>
    <tr>
        <td><center><img src="https://img-blog.csdnimg.cn/a353ababb2fa43bd8b93a5a66cb40ff0.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16">2</center></td>
        <td><center><img src="https://img-blog.csdnimg.cn/726cb804d1694948a02f9bca8b5a3c49.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16">3</center></td>
    </tr>
    <tr>
        <td><center><img src="https://img-blog.csdnimg.cn/243b7516b36443abb7996559778f38e5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16">2-局部</center></td>
        <td><center><img src="https://img-blog.csdnimg.cn/3371955b7e3f442596dcce8ee76d24a2.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16">3-局部</center></td>
    </tr>
</tbody></table>
等级为2，3的网格过于密集，局部放大图如上所示。
<h2><a id="Dinosaur_258"></a>Dinosaur</h2>
<p>加密等级为0，1，2，3时的网格，其中等级0的为原网格。</p>
<table>
    <tbody><tr>
        <td><center><img src="https://img-blog.csdnimg.cn/8e68ebc0e82449f5950ffe4367b53ba6.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16">0</center></td>
        <td><center><img src="https://img-blog.csdnimg.cn/2b1732c3d92c4aa9b8382f8ac9b2e0b4.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16">1</center></td>
    </tr>
    <tr>
        <td><center><img src="https://img-blog.csdnimg.cn/cf9a9be7259d41a2a306e3da5ac20b32.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16">2</center></td>
        <td><center><img src="https://img-blog.csdnimg.cn/cbdd545613134c33887164104717f49b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16">3</center></td>
    </tr>
    <tr>
        <td><center><img src="https://img-blog.csdnimg.cn/ff83e89a83304846a671626d124cba13.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16">2-局部</center></td>
        <td><center><img src="https://img-blog.csdnimg.cn/bee2d7cba91d4a80a9fba3e4fa65521d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAem9uZ3kxNw==,size_20,color_FFFFFF,t_70,g_se,x_16">3-局部</center></td>
    </tr>
</tbody></table>
等级为2，3的网格过于密集，局部放大图如上所示。

    </div>
  </div>
</body>

</html>
